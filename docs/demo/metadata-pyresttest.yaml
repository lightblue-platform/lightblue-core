# Tests of metadata service.
# Notes on json validation:
#   must supply count or expected
#   if supply expected can optionally specify operator
#   operator defaults to "eq", available values are: abs contains eq ge gt index inv invert le lt ne neg not pos truth
#   operator is applied as: <actual> <operator> <expected>
---
- config:
    - testset: "Metadata Test"
    - headers: {Content-Type: application/json}

# Tests that do not require any specific state.

- test: # verify get verisons for invalid entity
    - name: "Invalid Entity"
    - url: "/metadata/ThisEntityDoesNotExist" 
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "versions", count: 0}

# Verify initial state.

- test: # verify initial state, should not have any versions for the entity being tested
    - name: "Initial State"
    - url: "/metadata/${ENTITY_NAME}"
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - validators:
        - {type: "json", query: "entities", count: 0}

# Create v1 of the entity.

- test: # create entity
    - name: "Create Metadata"
    - url: "/metadata/${ENTITY_NAME}/${ENTITY_VERSION_1}"
    - headers: {Content-Type: application/json}
    - group: "metadata/insert"
    - method: "PUT"
    - body: {file: "test-metadata-insert.json"}
    - validators:
        - {type: "json", query: "object_type", operator: "empty", expected: ""}

# Verify v1.

- test: # verify getting entity name list
    - name: "Verify Create: /metadata"
    - url: "/metadata" 
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - method: "GET"
    - expected_status: 200
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "entities", operator: "gt", expected: 0}
        - {type: "json", query: "entities", operator: "contains", expected: "${ENTITY_NAME}"}
- test: # verify get verisons for valid entity
    - name: "Verify Create: /metadata/entity"
    - url: "/metadata/${ENTITY_NAME}"
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "versions", count: 1}
- test: # verify get specific version
    - name: "Verify Create: /metadata/entity/v1"
    - url: "/metadata/${ENTITY_NAME}/${ENTITY_VERSION_1}"
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "entityInfo/name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {type: "json", query: "entityInfo/defaultVersion", operator: "empty", expected: ""}
        - {type: "json", query: "schema/version/value", operator: "eq", expected: "${ENTITY_VERSION_1}"}
        - {type: "json", query: "schema/status/value", operator: "eq", expected: "active"}

# Create v2 of the entity.

- test: # create schema
    - name: "Create Schema"
    - url: "/metadata/${ENTITY_NAME}/schema=${ENTITY_VERSION_2}"
    - headers: {Content-Type: application/json}
    - group: "metadata/insert"
    - method: "PUT"
    - body: {file: "test-metadata-update-v2.json"}
    - validators:
        - {type: "json", query: "object_type", operator: "empty", expected: ""}

# Verify v2.

- test: # verify getting entity name list
    - name: "Verify Schema: /metadata"
    - url: "/metadata" 
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - method: "GET"
    - expected_status: 200
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "entities", operator: "gt", expected: 0}
        - {type: "json", query: "entities", operator: "contains", expected: "${ENTITY_NAME}"}
- test: # verify get verisons for valid entity
    - name: "Verify Schema: /metadata/entity"
    - url: "/metadata/${ENTITY_NAME}"
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "versions", count: 2}
- test: # verify get specific version (v1 is still active)
    - name: "Verify Schema: /metadata/entity/v1"
    - url: "/metadata/${ENTITY_NAME}/${ENTITY_VERSION_1}"
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "entityInfo/name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {type: "json", query: "entityInfo/defaultVersion", operator: "empty", expected: ""}
        - {type: "json", query: "schema/version/value", operator: "eq", expected: "${ENTITY_VERSION_1}"}
        - {type: "json", query: "schema/status/value", operator: "eq", expected: "active"}
- test: # verify get specific version (v2 exists and is active)
    - name: "Verify Schema: /metadata/entity/v2"
    - url: "/metadata/${ENTITY_NAME}/${ENTITY_VERSION_2}"
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "entityInfo/name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {type: "json", query: "entityInfo/defaultVersion", operator: "empty", expected: ""}
        - {type: "json", query: "schema/version/value", operator: "eq", expected: "${ENTITY_VERSION_2}"}
        - {type: "json", query: "schema/status/value", operator: "eq", expected: "active"}

# Update entity info, add an index.

- test: # verify has no index initially
    - name: "Verify Index Missing"
    - url: "/metadata/${ENTITY_NAME}/${ENTITY_VERSION_2}"
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - method: "GET"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "entityInfo/name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {type: "json", query: "entityInfo/indexes", operator: "empty", expected: ""}
- test: # add index
    - name: "Add Index"
    - url: "/metadata/${ENTITY_NAME}"
    - headers: {Content-Type: application/json}
    - group: "metadata/update"
    - method: "PUT"
    - body: {file: "test-metadata-update-index.json"}
- test: # verify has index after update
    - name: "Verify Index Added"
    - url: "/metadata/${ENTITY_NAME}/${ENTITY_VERSION_2}"
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - method: "GET"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "entityInfo/name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {type: "json", query: "entityInfo/defaultVersion", operator: "empty", expected: ""}
        - {type: "json", query: "entityInfo/indexes", count: 1}

# Test default functionality
# NOTE previous tests must have verified that each version is NOT default

- test: # make v2 default
    - name: "Update Default: v2"
    - url: "/metadata/${ENTITY_NAME}/${ENTITY_VERSION_2}/default"
    - headers: {Content-Type: application/json}
    - group: "metadata/update"
    - method: "POST"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "entityInfo/name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {type: "json", query: "schema/version/value", operator: "eq", expected: "${ENTITY_VERSION_2}"}
        - {type: "json", query: "entityInfo/defaultVersion", operator: "eq", expected: "${ENTITY_VERSION_2}"}

# Deprecate v1.

- test: # do deprecation
    - name: "Deprecate: v1"
    - url: "/metadata/${ENTITY_NAME}/${ENTITY_VERSION_1}/deprecated"
    - headers: {Content-Type: application/json}
    - group: "metadata/update"
    - method: "PUT"
    - body: "testing deprecation"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "entityInfo/name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {type: "json", query: "schema/version/value", operator: "eq", expected: "${ENTITY_VERSION_1}"}
        - {type: "json", query: "schema/status/value", operator: "eq", expected: "deprecated"}
#        - {type: "json", query: "schema/version/changelog", operator: "eq", expected: "testing deprecation"}
- test: # verify find gets same deprecated version
    - name: "Verify Deprecation: v1"
    - url: "/metadata/${ENTITY_NAME}/${ENTITY_VERSION_1}"
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - method: "GET"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "entityInfo/name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {type: "json", query: "schema/version/value", operator: "eq", expected: "${ENTITY_VERSION_1}"}
        - {type: "json", query: "schema/status/value", operator: "eq", expected: "deprecated"}
#        - {type: "json", query: "schema/version/changelog", operator: "eq", expected: "testing deprecation"}

# Disable v1.

- test: # do disabling
    - name: "Disable: v1"
    - url: "/metadata/${ENTITY_NAME}/${ENTITY_VERSION_1}/disabled"
    - headers: {Content-Type: application/json}
    - group: "metadata/update"
    - method: "PUT"
    - body: "testing disabled"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "entityInfo/name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {type: "json", query: "schema/version/value", operator: "eq", expected: "${ENTITY_VERSION_1}"}
        - {type: "json", query: "schema/status/value", operator: "eq", expected: "disabled"}
#        - {type: "json", query: "schema/version/changelog", operator: "eq", expected: "testing disabled"}
- test: # verify find gets same disabled version
    - name: "Verify Disabled: v1"
    - url: "/metadata/${ENTITY_NAME}/${ENTITY_VERSION_1}"
    - headers: {Content-Type: application/json}
    - group: "metadata/find"
    - method: "GET"
    - validators: # operator is applied as: <actual> <operator> <expected>
        - {type: "json", query: "entityInfo/name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {type: "json", query: "schema/version/value", operator: "eq", expected: "${ENTITY_VERSION_1}"}
        - {type: "json", query: "schema/status/value", operator: "eq", expected: "disabled"}
#        - {type: "json", query: "schema/version/changelog", operator: "eq", expected: "testing disabled"}

